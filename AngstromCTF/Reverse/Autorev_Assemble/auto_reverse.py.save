import os 
import sys
import time

def print_flag(flag):
    flag_disp = ""
    for letters in flag:
        flag_disp += letters
    print("Flag: " + flag_disp, end='\r'),
    time.sleep(0.05)

def extract_func(func_name, disass):
    separator = "<" + str(func_name) + ">"
    content = str(disass).split(separator)[1].split("\n\n")[0]
    return content

def resolve_equa(func_content, func_name, flag):
    nb_lines = str(func_content).count("\n")
    for x in range(0, nb_lines):
        line = str(func_content).split("\n")
        
        #Getvthe cmp value
        if "cmp" in str(line[x]):
            cmp_value = chr(int(str(line[x]).split("$")[1].split(",")[0], 16))

    #Get the operator and the operande value
    op_line = line[5]
    
    if "add" in op_line:
        #Equation POV, if the function is adding something, we need to performe a minus.
        operator = "-"
        value = int(str(op_line).split("$")[1].split(",")[0], 16)
#        print("Function <" + str(func_name) + "> Char " + str(value) + " = " + str(cmp_value))
        flag[int(str(value), 10)] = str(cmp_value)
        print_flag(flag)
    elif "sub" in op_line:
        #Idem, if it' a '-', we need to add something to resolve it
        operator = "+"
        value = str(op_line).split("$")[1].split(",")[0]
    else:
        #Just here to fuck with the script, thanks !
        operator = "movzbl"
        value = "NA"

    #exit(1)

    return flag

disassemble_cmd = "objdump -M Intel -tS autorev_assemble"
disass = os.popen(disassemble_cmd).read()
nb_call = 0
flag = ["*"]*200

print_flag(flag)

#Disassemble main function
main = extract_func("main", disass)

#Get each separated main instructions
for main_op in main.split("\n"):

    #Only keep the call xxx instruction, and remove call from the PLT
    if "call" in main_op and "@" not in main_op:

        #Extract function's name
        func_name = str(main_op).split("<")[1].split(">")[0]
        
        #Extract function's instructions from it's name
        func_content = extract_func(func_name, disass)
        
        #Break it
        flag = resolve_equa(func_content, func_name, flag)
        ##print(a)

        nb_call += 1
#Small cheat, i guess the two missing letters
flag[0] = "b"
flag[128] = "_"
print("[+] Found a total of " + str(nb_call) + " functions to reverse")
a = print_flag(flag)
print(a)
